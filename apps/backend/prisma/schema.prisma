generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           BigInt   @id @default(autoincrement())
  email        String   @unique
  passwordHash String   @map("password_hash")
  displayName  String   @map("display_name")
  role         String   @default("user")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  wallet        Wallet?
  books         Book[]
  dealsAsSeller Deal[]  @relation("DealSeller")
  dealsAsBuyer  Deal[]  @relation("DealBuyer")

  @@map("users")
}

model Wallet {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt   @unique @map("user_id")
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model Book {
  id      BigInt @id @default(autoincrement())
  ownerId BigInt @map("owner_id")

  title       String
  author      String?
  description String?

  coverUrl String? @map("cover_url")

  status    BookStatus @default(available)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  deals Deal[]

  @@index([ownerId])
  @@map("books")
}

model Deal {
  id BigInt @id @default(autoincrement())

  bookId   BigInt @map("book_id")
  sellerId BigInt @map("seller_id")
  buyerId  BigInt @map("buyer_id")

  status DealStatus @default(pending)

  pickupPointId   String?   @map("pickup_point_id")
  trackingNumber  String?   @map("tracking_number")
  sellerShippedAt DateTime? @map("seller_shipped_at")
  buyerReceivedAt DateTime? @map("buyer_received_at")

  acceptedAt DateTime? @map("accepted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  book   Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
  seller User @relation("DealSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  buyer  User @relation("DealBuyer", fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([bookId])
  @@index([sellerId])
  @@index([buyerId])
  @@map("deals")
}

enum BookStatus {
  available
  reserved
  exchanged
}

enum DealStatus {
  pending
  accepted
  pickup_selected
  shipped
  completed
  rejected
  cancelled
}
