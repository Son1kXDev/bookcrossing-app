<div class="max-w-5xl mx-auto p-4 space-y-6">
  <header class="flex items-center justify-between gap-3">
    <h1 class="text-xl font-semibold">Сделки</h1>
    <button
      (click)="reload()"
      [disabled]="loading"
      class="px-3 py-2 rounded-lg border border-gray-950/10 hover:bg-gray-950/5"
    >
      Обновить
    </button>
  </header>

  @if(loading){
    <div class="opacity-70">Загрузка…</div>
  } @else if(error){
    <div class="text-red-600">{{ error }}</div>
  } @else {

    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Исходящие</h2>
        <div class="text-sm opacity-70">Всего: {{ outgoing.length }}</div>
      </div>

      @if(outgoing.length === 0){
        <div class="rounded-xl border p-4 opacity-70">Пока нет исходящих сделок.</div>
      } @else {
        <div class="grid gap-3">
          @for(d of outgoing; track d.id){
            <div class="rounded-xl border p-4 space-y-2 bg-white">
              <div class="flex items-start justify-between gap-3">
                <div class="space-y-1">
                  <div class="font-medium">{{ titleOf(d) }}</div>

                  @if(d.pickupPointId){
                    <div class="text-xs opacity-60">ПВЗ: {{ d.pickupPointId }}</div>
                  }
                  @if(d.trackingNumber){
                    <div class="text-xs opacity-60">Трек: {{ d.trackingNumber }}</div>
                  }
                </div>

                <span class="text-xs px-2 py-1 rounded bg-black/5">{{ outgoingStatusLabel(d.status)}}</span>
              </div>

              <div class="flex flex-wrap gap-2 pt-1">
                @if (d.status === 'pending') {
                  <button (click)="cancel(d)" class="px-3 py-2 rounded-lg bg-black/10 hover:bg-black/15">
                    Отменить
                  </button>
                }

                @if (d.status === 'accepted') {
                  <button (click)="openPvz(d)" class="px-3 py-2 rounded-lg bg-black text-white hover:opacity-90">
                    Выбрать ПВЗ
                  </button>
                }

                @if (d.status === 'shipped') {
                  <button (click)="receive(d)" class="px-3 py-2 rounded-lg bg-black text-white hover:opacity-90">
                    Подтвердить получение
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </section>

    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Входящие</h2>
        <div class="text-sm opacity-70">Всего: {{ incoming.length }}</div>
      </div>

      @if(incoming.length === 0){
        <div class="rounded-xl border p-4 opacity-70">Пока нет входящих сделок.</div>
      } @else {
        <div class="grid gap-3">
          @for(d of incoming; track d.id){
            <div class="rounded-xl border p-4 space-y-2 bg-white">
              <div class="flex items-start justify-between gap-3">
                <div class="space-y-1">
                  <div class="font-medium">{{ titleOf(d) }}</div>

                  @if(d.pickupPointId){
                    <div class="text-xs opacity-60">ПВЗ: {{ d.pickupPointId }}</div>
                  }
                  @if(d.trackingNumber){
                    <div class="text-xs opacity-60">Трек: {{ d.trackingNumber }}</div>
                  }
                </div>

                <span class="text-xs px-2 py-1 rounded bg-black/5">{{ incomingStatusLabel(d.status) }}</span>
              </div>

              @if(d.status === 'pending'){
                <div class="flex flex-wrap gap-2 pt-1">
                  <button class="px-3 py-2 rounded-lg bg-black text-white hover:opacity-90" (click)="accept(d)">
                    Подтвердить
                  </button>
                  <button class="px-3 py-2 rounded-lg bg-black/10 hover:bg-black/15" (click)="reject(d)">
                    Отклонить
                  </button>
                </div>
              }

              @if(d.status === 'pickup_selected'){
                <div class="space-y-2 pt-1">
                  <label class="block">
                    <div class="text-xs opacity-70 mb-1">Трек-номер</div>
                    <input
                      class="w-full border rounded-lg px-3 py-2"
                      [(ngModel)]="tracking[d.id]"
                      name="t{{d.id}}"
                    />
                  </label>
                  <button [disabled]="!tracking[d.id]" class="px-3 py-2 rounded-lg bg-black text-white hover:opacity-90 disabled:opacity-40" (click)="ship(d)">
                    Подтвердить отправку
                  </button>
                </div>
              }
            </div>
          }
        </div>
      }
    </section>

    <app-pvz-picker
      [open]="pvzOpen"
      (close)="pvzOpen=false"
      (selected)="selectPvz($event)"
    />
  }
</div>
